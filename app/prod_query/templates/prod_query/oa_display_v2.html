{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Operational Availability by Line</title>
        <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
        <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script src="{% static 'chart.js/chart.umd.js' %}"></script>
        <script src="{% static 'moment.js/moment.min.js' %}"></script>
        <script src="{% static 'chart.js/chartjs-adapter-moment.min.js' %}"></script>
        <script src="{% static 'chart.js/chartjs-plugin-regression.min.js' %}"></script>
    </head>
<body>
    <style>
        .percentage-down {
            cursor: pointer;
        }
        .downtime-minutes {
            cursor: pointer;
        }
        #operation-search {
            max-width: 125px; /* Adjust width */
            font-size: 12px;  /* Adjust font size */
        }
        .original-target {
            cursor: pointer;
        }
    </style>

    <!-- Navbar with Back Button -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="{% url 'prod_query:prod-query_index' %}">
            <button type="button" class="btn btn-outline-dark mx-3">Back</button>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
    </nav>
    <!-- JE Logo and Title Section -->
    <div class="container mt-4">
        <div class="row bordered mb-3 text-center">
            <div class="col-12">
                <img src="{% static 'images/JE_Logo_PNG.png' %}" alt="JE Logo" style="height: 50px; margin-bottom: 10px;">
                <h1>Overall Equipment Effectiveness by Line</h1>
            </div>
        </div>
    </div>
    <div class="container mt-5">
        <div class="d-flex mb-4 gap-3 align-items-end">
            <!-- Date Picker -->
            <div>
                <label for="date-picker" class="form-label">Select Date:</label>
                <input type="date" id="date-picker" class="form-control">
            </div>

            <!-- Line Selection Dropdown -->
            <div>
                <label for="line-select" class="form-label">Select Line:</label>
                <select id="line-select" class="form-select">
                    <option value="" selected>-- Select a Line --</option>
                </select>
            </div>
        </div>

        <!-- Buttons for Previous and Next Week -->
        <div class="d-flex justify-content-start gap-2 mt-3">
            <button id="previous-week" class="btn btn-secondary">Previous Week</button>
            <button id="next-week" class="btn btn-secondary d-none">Next Week</button>
        </div>

        <style>
            .form-control, .form-select {
                height: calc(2.5rem + 2px); /* Standardize heights */
                display: inline-block; /* Prevent layout shifts */
            }
        </style>

        <!-- OA Results -->
        <div id="oa-results-section" class="card mt-4 d-none">
            <div class="card-body">
                <div id="oa-results" class="alert alert-warning"></div>
            </div>
        </div>

        <!-- Scrap Details Button -->
        <button id="scrap-details" class="btn btn-dark mt-3">Scrap Details</button>
        <button id="export-csv" class="btn btn-warning mt-3">Export as CSV</button>

        <!-- Scrap Details Modal -->
        <div class="modal fade" id="scrapDetailsModal" tabindex="-1" aria-labelledby="scrapDetailsLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="scrapDetailsLabel">Scrap Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="scrap-details-content">
                            <!-- Content will be dynamically populated -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div id="results-section" class="mb-4 d-none">
            <h2 id="results-title" class="text-center text-dark mb-4"></h2> <!-- Styled title -->
            <div id="results-container"></div>
        </div>

        <!-- Spinner -->
        <div id="loading-spinner" class="text-center d-none">
            <div class="spinner-border text-dark" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading data, please wait...</p>
        </div>
    </div>

    <!-- Modal: Downtime Details -->
    <div class="modal fade" id="downtimeDetailsModal" tabindex="-1" aria-labelledby="downtimeDetailsLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="downtimeDetailsLabel">Downtime Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Content will be dynamically updated -->
                    <div id="downtime-details-content"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Original Target Modal -->
    <div class="modal fade" id="originalTargetModal" tabindex="-1" aria-labelledby="originalTargetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="originalTargetModalLabel">Update Original Target</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="originalTargetForm">
                        <div class="mb-3">
                            <label for="machine-display" class="form-label">Machine Number:</label>
                            <input type="text" class="form-control" id="machine-display" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="current-original-target" class="form-label">Current Original Target:</label>
                            <input type="number" class="form-control" id="current-original-target" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="effective-date" class="form-label">Effective Date:</label>
                            <input type="date" class="form-control" id="effective-date" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="target-input" class="form-label">New Target:</label>
                            <input type="number" class="form-control" id="target-input" required>
                        </div>
                        <input type="hidden" id="machine-id" value="">
                    </form>
                </div>                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" id="save-target-btn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== SCRIPT: Handle Original Target Updating ========== -->
    <script>
        $(document).ready(function () {
            // Function to calculate the Sunday of the week for a given date
            function getSundayOfWeek(date) {
                const pickedDate = new Date(date + "T00:00:00"); // Parse as local time
                const day = pickedDate.getDay(); // Get the day of the week
                const difference = day === 0 ? 0 : -day; // Adjust to the nearest Sunday
                pickedDate.setDate(pickedDate.getDate() + difference);
                return pickedDate.toISOString().split('T')[0];
            }
    
            // Event handler for clicking on an original target cell
            $(document).on('click', '.original-target', function () {
                const machineId = $(this).data('machine-id');
                const currentTarget = $(this).text().trim();
    
                console.log("Clicked machine ID:", machineId);
                console.log("Current Original Target:", currentTarget);
    
                // Populate modal fields
                $('#machine-id').val(machineId);
                $('#machine-display').val(machineId);
                $('#current-original-target').val(currentTarget);
    
                if (window.startDateISO) {
                    console.log("Found startDateISO:", window.startDateISO);
                    const date = new Date(window.startDateISO);
                    const formattedDate = date.getFullYear() +
                        '-' + String(date.getMonth() + 1).padStart(2, '0') +
                        '-' + String(date.getDate()).padStart(2, '0');
                    console.log("Formatted effective date:", formattedDate);
                    $('#effective-date').val(formattedDate);
                } else {
                    console.warn("startDateISO is not defined!");
                    $('#effective-date').val('');
                }
    
                // Reset input field for new target
                $('#target-input').val('');
                // Show the modal
                $('#originalTargetModal').modal('show');
                console.log("Modal is displayed.");
            });
    
            // Event handler for saving the target
            $('#save-target-btn').on('click', function () {
                const machineId = $('#machine-id').val();
                const pickedDate = $('#effective-date').val();
                const targetInput = $('#target-input').val();
                const selectedLine = $('#line-select').val();
            
                console.log("Save Target Button Clicked");
                console.log("Machine ID:", machineId);
                console.log("Effective Date:", pickedDate);
                console.log("Target Input:", targetInput);
                console.log("Selected Line:", selectedLine);
            
                if (!pickedDate || !targetInput) {
                    alert('Please fill out all fields!');
                    return;
                }
            
                // Adjust the effective date to the Sunday of the week
                const effectiveDate = getSundayOfWeek(pickedDate);
                console.log("Effective Date (adjusted to Sunday):", effectiveDate);
            
                // Perform AJAX request to save the target
                $.ajax({
                    url: "{% url 'prod_query:update_target' %}",
                    type: "POST",
                    contentType: "application/json", // Specify JSON content type
                    data: JSON.stringify({
                        machine_id: machineId,
                        effective_date: effectiveDate,
                        target: targetInput,
                        line: selectedLine
                    }), // Send data as JSON
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function (response) {
                        console.log("Response from backend:", response);
                        if (response.error) {
                            alert(`Error: ${response.error}`);
                        } else {
                            alert('Target updated successfully!');
                            $('#originalTargetModal').modal('hide');
                            // Refresh the table using the existing logic
                            $('#line-select, #date-picker').trigger('change');
                        }
                    },
                    error: function (xhr) {
                        console.error("Error response from backend:", xhr);
                        alert('An error occurred while updating the target. Please try again.');
                    }
                });
            });
        });
    </script>

    <!-- ========== SCRIPT: Show or Hide Next Week Button Based on Date ========== -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const datePicker = document.getElementById('date-picker');
            const nextWeekButton = document.getElementById('next-week');

            const shouldShowNextButton = (selectedDate) => {
                const today = new Date();
                const startOfCurrentWeek = new Date(today);
                startOfCurrentWeek.setDate(today.getDate() - today.getDay());
                startOfCurrentWeek.setHours(0, 0, 0, 0);
                return selectedDate < startOfCurrentWeek;
            };

            const toggleNextWeekButton = () => {
                const selectedDate = new Date(datePicker.value);
                if (isNaN(selectedDate)) {
                    nextWeekButton.classList.add('d-none');
                    return;
                }

                if (shouldShowNextButton(selectedDate)) {
                    nextWeekButton.classList.remove('d-none');
                } else {
                    nextWeekButton.classList.add('d-none');
                }
            };

            toggleNextWeekButton();
            datePicker.addEventListener('change', toggleNextWeekButton);
        });
    </script>

    <!-- ========== SCRIPT: Show/Hide Scrap & CSV Buttons ========== -->
    <script>
        $(document).ready(function () {
            const scrapDetailsButton = $('#scrap-details');
            const exportCsvButton = $('#export-csv');

            scrapDetailsButton.hide();
            exportCsvButton.hide();

            function toggleButtons() {
                const selectedLine = $('#line-select').val();
                if (selectedLine) {
                    scrapDetailsButton.show();
                    exportCsvButton.show();
                } else {
                    scrapDetailsButton.hide();
                    exportCsvButton.hide();
                }
            }

            $('#line-select').on('change', function () {
                toggleButtons();
            });

            toggleButtons();
        });
    </script>

    <!-- ========== SCRIPT: Display Scrap Details in a Modal ========== -->
    <script>
        $(document).ready(function () {
            function formatToISO(dateStr) {
                const date = new Date(dateStr);
                if (isNaN(date)) {
                    console.error("Invalid date format:", dateStr);
                    return null;
                }
                return date.toISOString();
            }

            $('#scrap-details').on('click', function () {
                if (!window.scrapAmount || !window.startDateISO) {
                    alert('Please select a line and date to load scrap details.');
                    return;
                }

                $('#scrap-details-content').html('<p>Loading scrap details...</p>');
                $('#scrapDetailsModal').modal('show');

                const scrapLine = $('#line-select').val();
                let startDateISO = window.startDateISO;
                startDateISO = formatToISO(startDateISO);
                if (!startDateISO) {
                    $('#scrap-details-content').html('<p class="text-danger">Invalid start date format. Please try again.</p>');
                    return;
                }

                $.ajax({
                    url: "{% url 'prod_query:total_scrap' %}",
                    type: "GET",
                    data: {
                        scrap_line: scrapLine,
                        start_date: startDateISO
                    },
                    success: function (response) {
                        if (response.error) {
                            console.error("Error in response:", response.error);
                            $('#scrap-details-content').html(`<p class="text-danger">${response.error}</p>`);
                            return;
                        }

                        const scrapData = response.scrap_data || [];
                        if (scrapData.length === 0) {
                            $('#scrap-details-content').html('<p>No scrap details available for the selected line and date.</p>');
                            return;
                        }

                        let tableHtml = `
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover" id="scrap-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Scrap Part</th>
                                            <th>
                                                Scrap Operation
                                                <br />
                                                <input type="text" id="operation-search" class="form-control form-control-sm" placeholder="Search by Operation" />
                                            </th>
                                            <th>Scrap Category</th>
                                            <th>Scrap Amount</th>
                                            <th>Scrap Line</th>
                                            <th>Total Cost</th>
                                            <th>Date Current</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        scrapData.forEach(item => {
                            tableHtml += `
                                <tr>
                                    <td>${item['Scrap Part']}</td>
                                    <td class="scrap-operation">${item['Scrap Operation']}</td>
                                    <td>${item['Scrap Category']}</td>
                                    <td>${item['Scrap Amount']}</td>
                                    <td>${item['Scrap Line']}</td>
                                    <td>${item['Total Cost']}</td>
                                    <td>${new Date(item['Date Current']).toLocaleString()}</td>
                                </tr>
                            `;
                        });

                        tableHtml += `
                                    </tbody>
                                </table>
                            </div>
                        `;

                        $('#scrap-details-content').html(tableHtml);

                        // Simple filter by Operation
                        $('#operation-search').on('input', function () {
                            const searchTerm = $(this).val().toLowerCase();
                            $('#scrap-table tbody tr').each(function () {
                                const operation = $(this).find('.scrap-operation').text().toLowerCase();
                                if (operation.includes(searchTerm)) {
                                    $(this).show();
                                } else {
                                    $(this).hide();
                                }
                            });
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX Request Failed:", status, error, xhr.responseText);
                        $('#scrap-details-content').html('<p class="text-danger">An error occurred while fetching scrap details. Please try again later.</p>');
                    }
                });
            });
        });
    </script>

    <!-- ========== SCRIPT: Highlight Table Cells ========== -->
    <script>
        function highlightTable() {
            // Get all percentage down cells and create an array with their values
            const percentageDownCells = Array.from(document.querySelectorAll('.percentage-down')).map(cell => ({
                cell: cell,
                value: parseInt(cell.dataset.percentage, 10)
            })).filter(item => !isNaN(item.value));
        
            // Sort the array in descending order (worst first)
            percentageDownCells.sort((a, b) => b.value - a.value);
        
            // Reset any previously applied styles (optional)
            document.querySelectorAll('.percentage-down').forEach(cell => {
                cell.style.color = '';
                cell.style.fontWeight = '';
            });
        
            // Apply colors to the worst three machines
            if (percentageDownCells[0]) {
                percentageDownCells[0].cell.style.color = '#D32F2F'; // Worst machine - Dark Red
                percentageDownCells[0].cell.style.fontWeight = 'bold';
            }
            if (percentageDownCells[1]) {
                percentageDownCells[1].cell.style.color = '#F57C00'; // Second worst - Dark Orange
                percentageDownCells[1].cell.style.fontWeight = 'bold';
            }
            if (percentageDownCells[2]) {
                percentageDownCells[2].cell.style.color = '#FFB300'; // Third worst - Amber/Mustard
                percentageDownCells[2].cell.style.fontWeight = 'bold';
            }

        }
        
    </script>

    <!-- ========== SCRIPT: Display Downtime Details in a Modal ========== -->
    <script>
        $(document).on('click', '.percentage-down, .downtime-minutes', function () {
            const percentage = $(this).attr('data-percentage') || null;
            const downtime = $(this).attr('data-downtime') || null;
            const startDateISO = $(this).attr('data-startdateiso');
            const endOfWeek = $(this).attr('data-endofweek');
            const machine = $(this).attr('data-machine');

            if (machine === 'Subtotal' || machine === 'Total') {
                alert('Detailed downtime data is not available for subtotals or totals.');
                return;
            }

            $('#downtime-details-content').html('<p>Loading downtime details...</p>');
            $('#downtimeDetailsModal').modal('show');

            $.ajax({
                url: "{% url 'prod_query:pr_downtime' %}",
                type: "GET",
                data: {
                    assetnum: machine,
                    called4helptime: startDateISO,
                    completedtime: endOfWeek,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.error) {
                        $('#downtime-details-content').html(`<p class="text-danger">${response.error}</p>`);
                    } else {
                        let contentHTML = `<canvas id="spmChart" style="min-height: 150px; width: 100%;"></canvas>
                            <p><strong>Machine:</strong> ${machine}</p>
                            <p><strong>Start Date:</strong> ${new Date(startDateISO).toLocaleString()}</p>
                            <p><strong>End of Week:</strong> ${new Date(endOfWeek).toLocaleString()}</p>`;

                        if (percentage !== null) {
                            contentHTML += `<p><strong>Downtime Percentage:</strong> ${percentage}%</p>`;
                        } else if (downtime !== null) {
                            contentHTML += `<p><strong>Downtime:</strong> ${downtime} minutes</p>`;
                        }

                        if (response.data && response.data.length > 0) {
                            contentHTML += `<p><strong>Downtime Entries:</strong></p>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Problem</th>
                                                <th>Called for Help Time</th>
                                                <th>Completed Time</th>
                                                <th>Downtime (minutes)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;

                            response.data.forEach(entry => {
                                const problem = entry.problem || 'N/A';
                                const calledTime = entry.called4helptime ? new Date(entry.called4helptime).toLocaleString() : 'Unknown';
                                const completedTime = entry.completedtime ? new Date(entry.completedtime).toLocaleString() : 'Still in progress';
                                let downtimeMinutes = 'In Progress';
                                if (entry.called4helptime && entry.completedtime) {
                                    const calledDate = new Date(entry.called4helptime);
                                    const completedDate = new Date(entry.completedtime);
                                    const diffMs = completedDate - calledDate;
                                    const diffMinutes = Math.round(diffMs / 60000);
                                    downtimeMinutes = diffMinutes >= 0 ? diffMinutes : 'Invalid Time';
                                }

                                contentHTML += `
                                    <tr>
                                        <td>${problem}</td>
                                        <td>${calledTime}</td>
                                        <td>${completedTime}</td>
                                        <td>${downtimeMinutes}</td>
                                    </tr>
                                `;
                            });

                            contentHTML += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        } else {
                            contentHTML += '<p>No downtime entries found for this period.</p>';
                        }

                        $('#downtime-details-content').html(contentHTML);

                        // Chart with Strokes Per Minute if available
                        if (response.chart_data && response.chart_data.labels && response.chart_data.counts) {
                            const ctx = document.getElementById('spmChart');
                            new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: response.chart_data.labels,
                                    datasets: [{
                                        label: 'Strokes Per Minute',
                                        data: response.chart_data.counts,
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    scales: {
                                        y: { beginAtZero: true },
                                        x: { type: 'time' }
                                    },
                                    plugins: {
                                        legend: { display: true },
                                        title: { display: true, text: 'Strokes Per Minute' }
                                    }
                                }
                            });
                        }
                    }
                },
                error: function () {
                    $('#downtime-details-content').html('<p class="text-danger">An error occurred while fetching downtime details.</p>');
                }
            });
        });
    </script>

    <!-- ========== SCRIPT: Export Table to CSV ========== -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('export-csv').addEventListener('click', async () => {
                const table = document.querySelector('#results-container table');
                if (!table) {
                    alert('No data available to export!');
                    return;
                }

                const line = document.getElementById('line-select').value;
                const date = document.getElementById('date-picker').value;
                const filename = `${line}_${date}.csv`;

                function generateCSVContent() {
                    const rows = table.querySelectorAll('tr');
                    // Adjust if your table column count changes:
                    const expectedColumns = 11; // updated to 11 because we added a new OEE column

                    let csvContent = '';

                    rows.forEach(row => {
                        const cells = row.querySelectorAll('th, td');
                        let rowData = [];

                        cells.forEach((cell, index) => {
                            const cellText = cell.textContent.trim();
                            // For "Subtotal"/"Total" logic, ensure consistent columns
                            if (index === 0 && (cellText.startsWith('Subtotal') || cellText === 'Total')) {
                                rowData.push(`"${cellText}"`);
                                rowData.push(`""`);
                            } else {
                                const escapedText = cellText.replace(/"/g, '""');
                                rowData.push(`"${escapedText}"`);
                            }
                        });

                        // Pad missing cells if any
                        const missingCells = expectedColumns - rowData.length;
                        for (let i = 0; i < missingCells; i++) {
                            rowData.push(`""`);
                        }

                        csvContent += rowData.join(',') + '\r\n';
                    });

                    return csvContent;
                }

                const csvData = generateCSVContent();
                const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });
    </script>

    <!-- ========== SCRIPT: Set Default Date to Today ========== -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            const datePicker = document.getElementById('date-picker');
            datePicker.value = formattedDate;
        });
    </script>

    <!-- ========== SCRIPT: Previous/Next Week Buttons ========== -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            const datePicker = document.getElementById('date-picker');
            datePicker.value = formattedDate;

            const adjustDateByWeek = (date, weeks) => {
                const newDate = new Date(date);
                newDate.setDate(newDate.getDate() + weeks * 7);
                return newDate.toISOString().split('T')[0];
            };

            document.getElementById('previous-week').addEventListener('click', () => {
                const currentDate = new Date(datePicker.value);
                datePicker.value = adjustDateByWeek(currentDate, -1);
                datePicker.dispatchEvent(new Event('change'));
            });

            document.getElementById('next-week').addEventListener('click', () => {
                const currentDate = new Date(datePicker.value);
                datePicker.value = adjustDateByWeek(currentDate, 1);
                datePicker.dispatchEvent(new Event('change'));
            });
        });
    </script>

    <!-- ========== SCRIPT: Main Logic for Displaying Machine Data ========== -->
    <script>
        $(document).ready(function () {
            const lines = {{ lines|safe }};
            let ajaxRequestCount = 0;

            function showSpinner() {
                $('#loading-spinner').removeClass('d-none');
            }

            function hideSpinner() {
                $('#loading-spinner').addClass('d-none');
            }

            function incrementAjaxCount() {
                ajaxRequestCount++;
                if (ajaxRequestCount === 1) {
                    showSpinner();
                }
            }

            function decrementAjaxCount() {
                ajaxRequestCount--;
                if (ajaxRequestCount <= 0) {
                    ajaxRequestCount = 0;
                    hideSpinner();
                }
            }

            // Populate line-select
            lines.forEach(line => {
                $('#line-select').append(`<option value="${line.line}">${line.line}</option>`);
            });

            // Re-render table whenever line or date changes
            $('#line-select, #date-picker').change(function () {
                const selectedLine = $('#line-select').val();
                const selectedDate = $('#date-picker').val();

                if (!selectedLine || !selectedDate) {
                    return;
                }

                const selectedDateObj = new Date(selectedDate);
                if (isNaN(selectedDateObj)) {
                    alert('Invalid date selected!');
                    return;
                }

                const lineData = lines.find(line => line.line === selectedLine);
                const scrapLine = lineData.scrap_line;

                // Calculate start of week (Sunday)
                const startOfWeek = new Date(selectedDateObj);
                startOfWeek.setDate(selectedDateObj.getDate() - selectedDateObj.getDay());
                // For production data, we often capture from Sunday 23:00
                startOfWeek.setHours(23, 0, 0, 0);
                const startDateISO = startOfWeek.toISOString();

                incrementAjaxCount();
                $.ajax({
                    url: "{% url 'prod_query:gfx_downtime_and_produced' %}",
                    type: "POST",
                    data: {
                        machines: JSON.stringify(lineData.operations.flatMap(op => op.machines.map(m => m.number))),
                        line: selectedLine,
                        start_date: startDateISO,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function (data) {
                        if (data.error) {
                            console.error('Error:', data.error);
                            console.debug('Debug Logs:', data.debug);
                            alert(`Error: ${data.error}\nDebug Logs: ${JSON.stringify(data.debug, null, 2)}`);
                        } else {
                            displayMachineResults(data, lineData);
                        }
                    },
                    error: function (xhr) {
                        console.error('Request failed:', xhr);
                        alert(`Error: ${xhr.statusText}. Check console for details.`);
                    },
                    complete: function () {
                        decrementAjaxCount();
                    }
                });

                incrementAjaxCount();
                $.ajax({
                    url: "{% url 'prod_query:total_scrap' %}",
                    type: "GET",
                    data: {
                        scrap_line: scrapLine,
                        start_date: startDateISO
                    },
                    success: function (data) {
                        if (data.error) {
                            alert(data.error);
                        } else {
                            window.scrapAmount = data.total_scrap_amount;
                        }
                    },
                    error: function () {
                        alert('Error fetching scrap data. Please try again.');
                    },
                    complete: function () {
                        decrementAjaxCount();
                    }
                });
            });

            function displayMachineResults(data, lineData) {
                const downtimeResults = data.downtime_results || [];
                const producedResults = data.produced_results || [];
                const adjustedMachineTargets = data.machine_targets || {};
                const startDateStr = data.start_date;
                const endDateStr = data.end_date;

                const startDate = new Date(startDateStr);
                const endDate = new Date(endDateStr);
                const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                const formattedStartDate = startDate.toLocaleDateString(undefined, options);
                const formattedEndDate = endDate.toLocaleDateString(undefined, options);

                // Keep track in global scope for usage in modals
                window.startDateISO = startDateStr;
                window.endOfWeek = endDateStr;

                $('#results-title').text(`Results from ${formattedStartDate} to ${formattedEndDate}`);

                const selectedDate = new Date($('#date-picker').val());
                const now = new Date();

                let totalPotentialMinutesPerMachine = parseFloat(data.total_potential_minutes_per_machine) || 7200;
                // Re-calc for current in-progress week:
                const startOfWeek = new Date(selectedDate);
                startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
                startOfWeek.setHours(0, 0, 0, 0);

                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 5);
                endOfWeek.setHours(23, 0, 0, 0);

                // If "this week" is not yet complete, scale potential minutes
                if (now >= startOfWeek && now <= endOfWeek) {
                    const elapsedTime = now - startOfWeek;
                    const totalWeekTime = endOfWeek - startOfWeek;
                    const elapsedPercentage = elapsedTime / totalWeekTime;
                    totalPotentialMinutesPerMachine = 7200 * elapsedPercentage;
                }

                // Map each machine to its corresponding operation name
                const machineToOp = {};
                lineData.operations.forEach(opData => {
                    const op = opData.op;
                    opData.machines.forEach(machine => {
                        machineToOp[machine.number] = op;
                    });
                });

                // Setup data structure for each operation group
                const opGroups = {};
                lineData.operations.forEach(opData => {
                    const op = opData.op;
                    opGroups[op] = {
                        machines: [],
                        subtotal: {
                            downtime: 0,
                            produced: 0,
                            target: 0,
                            adjustedTarget: 0,
                            potentialMinutes: 0
                        }
                    };
                });

                const totals = {
                    totalDowntime: 0,
                    totalProduced: 0,
                    totalTarget: 0,
                    totalAdjustedTarget: 0,
                    totalPotentialMinutes: 0
                };

                downtimeResults.forEach((result) => {
                    const machine = result.machine;
                    let downtime = parseFloat(result.downtime) || 0;
                    downtime = Math.min(downtime, totalPotentialMinutesPerMachine);
                    downtime = Math.round(downtime);

                    const produced = parseFloat(producedResults.find(p => p.machine === machine)?.produced) || 0;
                    const targetInfo = adjustedMachineTargets[machine] || {};
                    const originalTarget = targetInfo.original_target || 0;
                    const adjustedOriginalTarget = targetInfo.adjusted_original_target || 0;

                    // Downtime % 
                    const percentageDown = totalPotentialMinutesPerMachine > 0
                        ? Math.round((downtime / totalPotentialMinutesPerMachine) * 100)
                        : 0;

                    // Adjusted Target
                    const adjustedTarget = Math.max(
                        0,
                        adjustedOriginalTarget * (1 - (downtime / totalPotentialMinutesPerMachine))
                    );

                    // P (Performance)
                    const P = (adjustedTarget === 0 && produced === 0) 
                        ? 1  // Edge case: if both zero, treat as 100%
                        : (adjustedTarget > 0 ? (produced / adjustedTarget) : 0);

                    // A (Availability)
                    const A = totalPotentialMinutesPerMachine > 0
                        ? Math.max(0, (totalPotentialMinutesPerMachine - downtime) / totalPotentialMinutesPerMachine)
                        : 0;

                    totals.totalDowntime += downtime;
                    totals.totalProduced += produced;
                    totals.totalTarget += adjustedOriginalTarget;
                    totals.totalAdjustedTarget += adjustedTarget;
                    totals.totalPotentialMinutes += totalPotentialMinutesPerMachine;

                    const op = machineToOp[machine] || 'Unknown';
                    opGroups[op].machines.push({
                        machine: machine,
                        downtime: downtime,
                        produced: produced,
                        target: adjustedOriginalTarget,
                        adjustedTarget: adjustedTarget,
                        potentialMinutes: totalPotentialMinutesPerMachine,
                        P: P,
                        A: A,
                        percentageDown: percentageDown
                    });

                    opGroups[op].subtotal.downtime += downtime;
                    opGroups[op].subtotal.produced += produced;
                    opGroups[op].subtotal.target += adjustedOriginalTarget;
                    opGroups[op].subtotal.adjustedTarget += adjustedTarget;
                    opGroups[op].subtotal.potentialMinutes += totalPotentialMinutesPerMachine;
                });

                const overallP = totals.totalAdjustedTarget > 0
                    ? (totals.totalProduced / totals.totalAdjustedTarget)
                    : 0;
                const overallA = totals.totalPotentialMinutes > 0
                    ? ((totals.totalPotentialMinutes - totals.totalDowntime) / totals.totalPotentialMinutes)
                    : 0;

                let tableHtml = `
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Op</th>
                            <th>Machine</th>
                            <th>Total Produced</th>
                            <th>Original Target</th>
                            <th>Adjusted Target</th>
                            <th>Downtime (minutes)</th>
                            <th>Total Potential Minutes</th>
                            <th>Percentage Down</th>
                            <th>P</th>
                            <th>A</th>
                            <!-- New column for OEE (P×A) -->
                            <th>OEE (P×A)</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                // Loop through each Op, print machines, then a subtotal row
                for (const op of Object.keys(opGroups)) {
                    const opData = opGroups[op];
                    tableHtml += `
                        <tr>
                            <td colspan="11" class="table-secondary"><strong>Op ${op}</strong></td>
                        </tr>
                    `;

                    opData.machines.forEach(machineData => {
                        const oeePercent = (machineData.P * machineData.A * 100).toFixed(2); // P×A * 100

                        tableHtml += `
                            <tr>
                                <td></td>
                                <td>${machineData.machine}</td>
                                <td>${machineData.produced}</td>
                                <td class="original-target" 
                                    data-machine-id="${machineData.machine}" 
                                    data-bs-toggle="tooltip" 
                                    title="Click to update original target">
                                    ${machineData.target.toFixed(0)}
                                </td>
                                <td>${machineData.adjustedTarget.toFixed(0)}</td>
                                <td class="downtime-minutes"
                                    data-downtime="${machineData.downtime}"
                                    data-startdateiso="${startDateStr}"
                                    data-endofweek="${endDateStr}"
                                    data-machine="${machineData.machine}"
                                    data-bs-toggle="tooltip"
                                    title="Click to view details">
                                    ${machineData.downtime}
                                </td>
                                <td>${machineData.potentialMinutes.toFixed(0)}</td>
                                <td class="percentage-down" 
                                    data-percentage="${machineData.percentageDown}" 
                                    data-startdateiso="${startDateStr}" 
                                    data-endofweek="${endDateStr}" 
                                    data-machine="${machineData.machine}" 
                                    data-bs-toggle="tooltip" 
                                    title="Click to view details">
                                    ${machineData.percentageDown}%
                                </td>
                                <td>${(machineData.P * 100).toFixed(2)}%</td>
                                <td>${(machineData.A * 100).toFixed(2)}%</td>
                                <td>${oeePercent}%</td>
                            </tr>
                        `;
                    });

                    const subtotalP = opData.subtotal.adjustedTarget > 0
                        ? opData.subtotal.produced / opData.subtotal.adjustedTarget
                        : (opData.subtotal.produced === 0 ? 1 : 0);
                    const subtotalA = opData.subtotal.potentialMinutes > 0
                        ? ((opData.subtotal.potentialMinutes - opData.subtotal.downtime) / opData.subtotal.potentialMinutes)
                        : 0;
                    const percentageDown = opData.subtotal.potentialMinutes > 0
                        ? Math.round((opData.subtotal.downtime / opData.subtotal.potentialMinutes) * 100)
                        : 0;
                    const subtotalPxA = subtotalP * subtotalA; // P×A
                    const subtotalPxAPercent = (subtotalPxA * 100).toFixed(2);

                    // Subtotal row
                    tableHtml += `
                        <tr class="table-warning">
                            <td colspan="2"><strong>Subtotal for Op ${op}</strong></td>
                            <td><strong>${opData.subtotal.produced}</strong></td>
                            <td><strong>${opData.subtotal.target.toFixed(0)}</strong></td>
                            <td><strong>${opData.subtotal.adjustedTarget.toFixed(0)}</strong></td>
                            <td class="downtime-minutes"
                                data-downtime="${opData.subtotal.downtime}"
                                data-startdateiso="${startDateStr}"
                                data-endofweek="${endDateStr}"
                                data-machine="Subtotal"
                                data-bs-toggle="tooltip"
                                title="Click to view details">
                                <strong>${opData.subtotal.downtime}</strong>
                            </td>
                            <td><strong>${opData.subtotal.potentialMinutes.toFixed(0)}</strong></td>
                            <td class="percentage-down" 
                                data-percentage="${percentageDown}" 
                                data-startdateiso="${startDateStr}" 
                                data-endofweek="${endDateStr}" 
                                data-machine="Subtotal" 
                                data-bs-toggle="tooltip" 
                                title="Click to view details">
                                <strong>${percentageDown}%</strong>
                            </td>
                            <td class="subtotal-p" data-p="${subtotalP}">
                                <strong>${(subtotalP * 100).toFixed(2)}%</strong>
                            </td>
                            <td class="subtotal-a" data-a="${subtotalA}">
                                <strong>${(subtotalA * 100).toFixed(2)}%</strong>
                            </td>
                            <!-- New cell for subtotal OEE (P×A) -->
                            <td class="subtotal-pxa" data-pxa="${subtotalPxA}">
                                <strong>${subtotalPxAPercent}%</strong>
                            </td>
                        </tr>
                    `;
                }

                const totalPercentageDown = totals.totalPotentialMinutes > 0
                    ? Math.round((totals.totalDowntime / totals.totalPotentialMinutes) * 100)
                    : 0;
                const oeePercentTotal = ((overallP * overallA) * 100).toFixed(2);

                tableHtml += `
                    </tbody>
                    <tfoot>
                        <tr class="table-success">
                            <th colspan="2">Total</th>
                            <th>${totals.totalProduced}</th>
                            <th>${totals.totalTarget.toFixed(0)}</th>
                            <th>${totals.totalAdjustedTarget.toFixed(0)}</th>
                            <td class="downtime-minutes"
                                data-downtime="${totals.totalDowntime}"
                                data-startdateiso="${startDateStr}"
                                data-endofweek="${endDateStr}"
                                data-machine="Total"
                                data-bs-toggle="tooltip"
                                title="Click to view details">
                                ${totals.totalDowntime}
                            </td>
                            <th>${totals.totalPotentialMinutes.toFixed(0)}</th>
                            <th class="percentage-down" 
                                data-percentage="${totalPercentageDown}" 
                                data-startdateiso="${startDateStr}" 
                                data-endofweek="${endDateStr}" 
                                data-machine="Total" 
                                data-bs-toggle="tooltip" 
                                title="Click to view details">
                                ${totalPercentageDown}%
                            </th>
                            <th>${(overallP * 100).toFixed(2)}%</th>
                            <th>${(overallA * 100).toFixed(2)}%</th>
                            <!-- New cell for total OEE (P×A) -->
                            <th>${oeePercentTotal}%</th>
                        </tr>
                    </tfoot>
                </table>`;

                $('#results-section').removeClass('d-none');
                $('#results-container').html(tableHtml);

                calculateOverallOA(overallP, overallA);
                highlightTable();
            }

            function calculateOverallOA(overallP, overallA) {
                // Q factor: Good part ratio
                const scrapAmount = window.scrapAmount || 0;

                // In many factories, final operation's produced count
                // is used for good parts. You can pick the last OP's "Subtotal" from the table:
                const lastOpSubtotalProduced = (() => {
                    const resultsTable = $('#results-container table tbody');
                    // Find the last .table-warning row (last subtotal)
                    const lastOpRow = resultsTable.find('tr.table-warning:last');
                    // 3rd <td> in the row = produced column (index 2 if zero-based)
                    const producedCell = lastOpRow.find('td:nth-child(3)');
                    return parseInt(producedCell.text().trim()) || 0;
                })();

                const Q = lastOpSubtotalProduced > 0
                    ? ((lastOpSubtotalProduced / (lastOpSubtotalProduced + scrapAmount)) * 100).toFixed(2)
                    : "0.00";

                // OA = (P * A * Q) in percentage
                const OA = (overallP * overallA * (Q / 100) * 100).toFixed(2);
                const overallPPercent = (overallP * 100).toFixed(2);
                const overallAPercent = (overallA * 100).toFixed(2);

                $('#oa-results-section').removeClass('d-none');
                $('#oa-results').html(`
                    <p><strong>Operational Availability:</strong> ${OA}% 
                       (P=${overallPPercent}%, A=${overallAPercent}%, Q=${Q}%)
                    </p>
                `);
            }
        });
    </script>
</body>
</html>
